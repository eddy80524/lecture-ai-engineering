import streamlit as st
import pandas as pd
from datetime import datetime
import uuid
import os

# -------- ãƒšãƒ¼ã‚¸è¨­å®š --------
st.set_page_config(
    page_title="å…¨å›½æ­¯å­¦éƒ¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ",
    layout="wide",
    initial_sidebar_state="expanded",
)

# -------- å®šæ•° --------
UNIVERSITIES = [
    # å›½ç«‹å¤§å­¦ï¼ˆ11æ ¡ï¼‰
    "åŒ—æµ·é“å¤§å­¦",
    "æ±åŒ—å¤§å­¦",
    "æ±äº¬åŒ»ç§‘æ­¯ç§‘å¤§å­¦",
    "æ–°æ½Ÿå¤§å­¦",
    "å¤§é˜ªå¤§å­¦",
    "å²¡å±±å¤§å­¦",
    "åºƒå³¶å¤§å­¦",
    "å¾³å³¶å¤§å­¦",
    "ä¹å·å¤§å­¦",
    "é•·å´å¤§å­¦",
    "é¹¿å…å³¶å¤§å­¦",
    # ç§ç«‹å¤§å­¦ï¼ãã®ä»–ï¼ˆ18æ ¡ï¼‰
    "å¤§é˜ªæ­¯ç§‘å¤§å­¦",
    "æ±äº¬æ­¯ç§‘å¤§å­¦",
    "æ˜­å’Œå¤§å­¦",
    "æ—¥æœ¬å¤§å­¦",
    "æ˜æµ·å¤§å­¦",
    "ç¥å¥ˆå·æ­¯ç§‘å¤§å­¦",
    "é¶´è¦‹å¤§å­¦",
    "æ¾æœ¬æ­¯ç§‘å¤§å­¦",
    "æ„›çŸ¥å­¦é™¢å¤§å­¦",
    "æœæ—¥å¤§å­¦",
    "åŒ—æµ·é“åŒ»ç™‚å¤§å­¦",
    "å²©æ‰‹åŒ»ç§‘å¤§å­¦",
    "å¥¥ç¾½å¤§å­¦",
    "æ—¥æœ¬æ­¯ç§‘å¤§å­¦ ç”Ÿå‘½æ­¯å­¦éƒ¨",
    "æ—¥æœ¬æ­¯ç§‘å¤§å­¦ æ–°æ½Ÿç”Ÿå‘½æ­¯å­¦éƒ¨",
    "ç¦å²¡æ­¯ç§‘å¤§å­¦",
    "ä¹å·æ­¯ç§‘å¤§å­¦",
    "é•·å´çœŒç«‹å¤§å­¦"
]

YEARS = ["1 å¹´", "2 å¹´", "3 å¹´", "4 å¹´", "5 å¹´", "6 å¹´", "ç ”ä¿®åŒ»"]

CSV_FILE = "responses.csv"

# -------- ã‚µã‚¤ãƒ‰ãƒãƒ¼ --------
with st.sidebar:
    st.header("ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ¦‚è¦")
    st.write("â€¢ åŒ¿åå›ç­”  â€¢ æ‰€è¦ç´„3åˆ†  â€¢ ç· åˆ‡: 2025-06-15")
    st.divider()

    # ã™ã§ã«å›ç­”ãŒã‚ã‚Œã°ã€ç°¡æ˜“é›†è¨ˆã‚’è¡¨ç¤º
    if os.path.exists(CSV_FILE):
        df_all = pd.read_csv(CSV_FILE)
        st.subheader("ğŸ“Š å¹³å‡ã‚¹ã‚³ã‚¢")
        st.write({
            "è¬›ç¾©å†…å®¹": df_all.lec_q.mean().round(2),
            "è‡¨åºŠå®Ÿç¿’": df_all.cli_q.mean().round(2),
            "ãƒ‡ã‚¸ã‚¿ãƒ«æ­¯ç§‘": df_all.digi_q.mean().round(2),
            "è‹±èªæ•™è‚²": df_all.eng_q.mean().round(2),
        })
        st.bar_chart(df_all[["lec_q", "cli_q", "digi_q", "eng_q"]])

# -------- ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ« --------
st.title("å…¨å›½æ­¯å­¦éƒ¨ç”Ÿã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ 2025")
st.caption("æ‰€è¦æ™‚é–“ â‰ˆ 3 åˆ† ï½œ å›ç­”ã¯åŒ¿åã§åé›†ã•ã‚Œã¾ã™")

# -------- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ  --------
with st.form("survey_form", clear_on_submit=True):
    # â‘  åŸºæœ¬å±æ€§
    st.subheader("â‘  åŸºæœ¬å±æ€§")
    university = st.selectbox("æ‰€å±å¤§å­¦ *", UNIVERSITIES)
    year       = st.selectbox("å­¦å¹´ *",     YEARS)
    gender     = st.radio("æ€§åˆ¥", ["ç”·æ€§", "å¥³æ€§", "å›ç­”ã—ãªã„"], index=2, horizontal=True)

    # â‘¡ å­¦ç¿’ç’°å¢ƒã®è©³ç´°è©•ä¾¡
    st.subheader("â‘¡ å­¦ç¿’ç’°å¢ƒã®è©³ç´°è©•ä¾¡")
    st.caption("â€» 1 = éå¸¸ã«ä¸æº€, 5 = éå¸¸ã«æº€è¶³")

    # --- è¬›ç¾©ãƒ»åº§å­¦ ---
    with st.expander("è¬›ç¾©ãƒ»åº§å­¦"):
        lec_clarity   = st.slider("è¬›ç¾©ã®åˆ†ã‹ã‚Šã‚„ã™ã•",                 1, 5, 3, format="%d")
        lec_materials = st.slider("è³‡æ–™ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ã®å……å®Ÿåº¦",             1, 5, 3, format="%d")
        lec_active    = st.slider("åŒæ–¹å‘çš„æˆæ¥­ï¼ˆè³ªç–‘ãƒ»ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ï¼‰ã®é »åº¦", 1, 5, 3, format="%d")
        lec_comment   = st.text_area("è¬›ç¾©ã«é–¢ã™ã‚‹ã”æ„è¦‹ï¼ˆä»»æ„ï¼‰", key="lec_c")

    # --- è‡¨åºŠå®Ÿç¿’ãƒ»å®ŸæŠ€ ---
    with st.expander("è‡¨åºŠå®Ÿç¿’ãƒ»å®ŸæŠ€"):
        cli_supervision = st.slider("æŒ‡å°åŒ»ã®ã‚µãƒãƒ¼ãƒˆä½“åˆ¶",     1, 5, 3, format="%d")
        cli_cases       = st.slider("ç—‡ä¾‹æ•°ãƒ»å¤šæ§˜æ€§",           1, 5, 3, format="%d")
        cli_feedback    = st.slider("å®Ÿç¿’å¾Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è³ª", 1, 5, 3, format="%d")
        cli_comment     = st.text_area("å®Ÿç¿’ã«é–¢ã™ã‚‹ã”æ„è¦‹ï¼ˆä»»æ„ï¼‰", key="cli_c")

    # --- ãƒ‡ã‚¸ã‚¿ãƒ«æ­¯ç§‘ãƒ»ICT ---
    with st.expander("ãƒ‡ã‚¸ã‚¿ãƒ«æ­¯ç§‘ãƒ»ICT"):
        digi_equipment = st.slider("CAD/CAMç­‰æ©Ÿå™¨ã®åˆ©ç”¨æ©Ÿä¼š",         1, 5, 3, format="%d")
        digi_curric    = st.slider("AIãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«æŠ€è¡“ã®è¬›ç¾©å……å®Ÿåº¦",     1, 5, 3, format="%d")
        digi_comment   = st.text_area("ãƒ‡ã‚¸ã‚¿ãƒ«æ•™è‚²ã®æ”¹å–„ç‚¹ï¼ˆä»»æ„ï¼‰", key="digi_c")

    # --- èªå­¦ãƒ»å›½éš›åŒ– ---
    with st.expander("èªå­¦ãƒ»å›½éš›åŒ–"):
        eng_general   = st.slider("ä¸€èˆ¬è‹±èªæˆæ¥­ã®è³ª",       1, 5, 3, format="%d")
        eng_clinical  = st.slider("æ­¯ç§‘å°‚é–€è‹±èªæ•™è‚²ã®å……å®Ÿåº¦", 1, 5, 3, format="%d")
        intl_exchange = st.slider("æµ·å¤–ç ”ä¿®ãƒ»äº¤æ›ç•™å­¦ã®æ©Ÿä¼š", 1, 5, 3, format="%d")
        eng_comment   = st.text_area("èªå­¦æ•™è‚²ã¸ã®è¦æœ›ï¼ˆä»»æ„ï¼‰", key="eng_c")

    # --- é‡è¦åº¦ãƒ’ã‚¢ãƒªãƒ³ã‚° ---
    importance = st.radio(
        "ä»Šå¾Œã€å¤§å­¦ãŒ **æœ€ã‚‚åŠ›ã‚’å…¥ã‚Œã‚‹ã¹ã** åˆ†é‡ã¯ï¼Ÿ",
        ["è¬›ç¾©ãƒ»åº§å­¦", "è‡¨åºŠå®Ÿç¿’", "ãƒ‡ã‚¸ã‚¿ãƒ«æ­¯ç§‘", "èªå­¦ãƒ»å›½éš›åŒ–", "ç ”ç©¶æ©Ÿä¼š"],
        horizontal=True
    )

    # â‘¢ ã‚­ãƒ£ãƒªã‚¢å¿—å‘
    st.subheader("â‘¢ ã‚­ãƒ£ãƒªã‚¢å¿—å‘")
    future_paths    = st.multiselect(
        "èˆˆå‘³ã®ã‚ã‚‹é€²è·¯ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰",
        ["å¤§å­¦é™¢", "è‡¨åºŠé–‹æ¥­åŒ»", "ç—…é™¢å‹¤å‹™", "ä¼æ¥­ï¼ç ”ç©¶è·", "æµ·å¤–è‡¨åºŠ", "å…¬è¡†è¡›ç”Ÿï¼å®˜å…¬åº", "ãã®ä»–"]
    )
    overseas_intent = st.slider("å’å¾Œ5å¹´ä»¥å†…ã«æµ·å¤–ã§åƒãæ„å‘ (%)", 0, 100, 0)

    # â‘£ ç¡çœ æ­¯ç§‘ã¸ã®é–¢å¿ƒ
    st.subheader("â‘£ ç¡çœ æ­¯ç§‘ã¸ã®é–¢å¿ƒ")
    sleep_knowledge  = st.slider("ç¡çœ æ­¯ç§‘ã®ç†è§£åº¦",                         1, 5, 3)
    sleep_curriculum = st.radio(
        "ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã«ç¡çœ æ­¯ç§‘ã®è¬›ç¾©ã‚’ã‚‚ã£ã¨å–ã‚Šå…¥ã‚Œã‚‹ã¹ãã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        ["å¼·ãæ€ã†", "ã‚„ã‚„æ€ã†", "ã©ã¡ã‚‰ã¨ã‚‚è¨€ãˆãªã„", "ã‚ã¾ã‚Šæ€ã‚ãªã„", "å…¨ãæ€ã‚ãªã„"],
        index=2
    )
    comments = st.text_area("è‡ªç”±è¨˜è¿°ï¼ˆä»»æ„ï¼‰", placeholder="ã”æ„è¦‹ãƒ»ã”è¦æœ›ãªã©")

    # é€ä¿¡ãƒœã‚¿ãƒ³
    submitted = st.form_submit_button("é€ä¿¡")
    if submitted:
        # ä¿å­˜å‡¦ç†â€¦
        st.success("ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼")
        st.balloons()
        header = not os.path.exists(CSV_FILE)
        df_new.to_csv(CSV_FILE, mode="a", index=False, header=header, encoding="utf-8")
        st.success("ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼")
        st.balloons()
